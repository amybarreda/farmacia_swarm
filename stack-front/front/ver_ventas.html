<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ventas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script>
  (function() {
    function getPort(key, def) {
      const q = new URLSearchParams(window.location.search).get('port_' + key.toLowerCase());
      const ls = localStorage.getItem('PORT_' + key.toUpperCase());
      return q || ls || def;
    }
    const gw = getPort('gateway', 3000);
    window.API_GATEWAY_BASE = `http://192.168.100.2:${gw}`;
    window.API_GATEWAY = `${window.API_GATEWAY_BASE}/api`;

    function baseFor(service) {
      const p = getPort(service, null);
      return p ? `http://192.168.100.2:${p}/api` : window.API_GATEWAY;
    }
    window.API_USUARIOS   = baseFor('usuarios');
    window.API_INVENTARIO = baseFor('inventario');
    window.API_COMPRAS    = baseFor('compras');
    window.API_VENTAS     = baseFor('ventas');
  })();
  </script>
</head>
<body class="p-3" style="background:linear-gradient(135deg,#ff5f6d,#ffc371);">
  <div class="container bg-white p-3 rounded shadow">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4 class="m-0">Ventas</h4>
      <div class="d-flex gap-2 align-items-center">
        <button id="btnTotalVentas" class="btn btn-sm btn-outline-success">Calcular total ventas</button>
        <span id="totalBadge" class="badge text-bg-success" style="display:none;"></span>
        <a class="btn btn-sm btn-outline-secondary" id="btnBack" href="#">Volver</a>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-striped" id="ventasTable">
        <thead>
          <tr>
            <th>ID</th><th>Vendedor</th><th>ID Medicamento</th><th>Producto</th>
            <th>Cant.</th><th>Medio Pago</th><th>Precio Unit.</th><th>Total</th><th>Fecha</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // ===== Endpoints (directo a microservicio de ventas) =====
    const API = { ventas: 'http://192.168.100.2:3004/api/ventas' };

    // ===== Guardia de sesión: permitir admin, employer y compras =====
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    const rolStore = (localStorage.getItem('rolUsuario') || '').toLowerCase();
    const rolUser  = (user ? String(user.role ?? user.tipo ?? user.rol ?? '').toLowerCase() : '');
    const rol = rolStore || rolUser;

    if (!rol) {
      alert('Sesión inválida. Vuelve a iniciar sesión.');
      window.location.href = 'login.html';
    }
    const allowed = new Set(['admin', 'employer', 'compras']);
    if (!allowed.has(rol)) {
      alert('Acceso no autorizado.');
      window.location.href = 'login.html';
    }

    // ===== Configurar el botón "Volver" según el rol =====
    const backHref =
      rol === 'employer' ? 'employer.html' :
      rol === 'compras'  ? 'compras.html'  :
      rol === 'admin'    ? 'admin.html'    : 'index.html';
    document.getElementById('btnBack').setAttribute('href', backHref);

    // ===== Lógica de página =====
    const tbody = document.querySelector('#ventasTable tbody');
    const totalBadge = document.getElementById('totalBadge');
    let cache = [];

    async function cargar() {
      const r = await fetch(API.ventas);
      const ventas = await r.json();
      cache = Array.isArray(ventas) ? ventas : [];
      tbody.innerHTML = '';
      if (!cache.length) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">Sin registros</td></tr>`;
        totalBadge.style.display = 'none';
        return;
      }
      cache.forEach(v => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${v.idVenta ?? ''}</td>
          <td>${v.idVendedor ?? ''}</td>
          <td>${v.idMedicamento ?? ''}</td>
          <td>${v.nombreMedicamento ?? ''}</td>
          <td>${v.cantidadVendida ?? ''}</td>
          <td>${v.medioPago ?? ''}</td>
          <td>${money(v.precioUnitario)}</td>
          <td>${money(v.totalVenta)}</td>
          <td>${v.fechaVenta ? new Date(v.fechaVenta).toLocaleString('es-CO') : ''}</td>`;
        tbody.appendChild(tr);
      });
      totalBadge.style.display = 'none';
    }

    function money(n){ n=Number(n||0); return n.toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0}); }

    document.getElementById('btnTotalVentas').addEventListener('click', () => {
      const total = cache.reduce((acc, v) => acc + Number(v.totalVenta||0), 0);
      totalBadge.textContent = 'Total: ' + money(total);
      totalBadge.style.display = 'inline-block';
    });

    cargar();
  </script>
</body>
</html>
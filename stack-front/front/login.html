<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login - Farmacia Powerpuff</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #ff5f6d, #ffc371);
      color: #333;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .login-card {
      background: #fff;
      padding: 2rem;
      border-radius: 15px;
      width: 380px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
      animation: fadeIn 0.6s ease-in-out;
    }
    .btn-bombon { background-color: #4ca1af; color: white; font-weight: bold; }
    .btn-bombon:hover { background-color: #3a8a9c; color: white; }
    h3 { font-weight: bold; color: #4ca1af; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
  </style>
<script>
(function() {
  function getPort(key, def) {
    const q = new URLSearchParams(window.location.search).get('port_' + key.toLowerCase());
    const ls = localStorage.getItem('PORT_' + key.toUpperCase());
    return q || ls || def;
  }
  const gw = getPort('gateway', 3000);
  window.API_GATEWAY_BASE = `http://192.168.100.2:${gw}`;
  window.API_GATEWAY = `${window.API_GATEWAY_BASE}/api`;

  function baseFor(service) {
    const p = getPort(service, null);
    return p ? `http://192.168.100.2:${p}/api` : window.API_GATEWAY;
  }
  window.API_USUARIOS   = baseFor('usuarios');
  window.API_INVENTARIO = baseFor('inventario');
  window.API_COMPRAS    = baseFor('compras');
  window.API_VENTAS     = baseFor('ventas');
})();
</script>
</head>
<body>
  <div class="login-card text-center">
    <h3><i class="bi bi-capsule"></i> Farmacia Powerpuff</h3>
    <p class="text-muted">Acceso seguro al sistema</p>

    <!-- FORMULARIO DE LOGIN -->
    <form id="loginForm" class="mt-3">
      <div class="mb-3 text-start">
        <label for="idUsuario" class="form-label">ID Usuario</label>
        <input id="idUsuario" name="idUsuario" type="text" class="form-control" placeholder="Ingrese su ID" required />
      </div>
      <div class="mb-3 text-start">
        <label for="password" class="form-label">Contrase√±a</label>
        <input id="password" name="password" type="password" class="form-control" placeholder="Ingrese su contrase√±a" required />
      </div>
      <button type="submit" class="btn btn-bombon w-100">
        <i class="bi bi-box-arrow-in-right"></i> Iniciar Sesi√≥n
      </button>
    </form>

    <!-- BOT√ìN VOLVER -->
    <button id="btnVolver" class="btn btn-secondary mt-3 w-100">
      <i class="bi bi-arrow-left-circle"></i> Volver al Inicio
    </button>

    <!-- ALERTAS -->
    <div id="mensajeBienvenida" class="alert alert-success mt-3 d-none"></div>
    <div id="mensajeError" class="alert alert-danger mt-3 d-none"></div>
  </div>

  <script>
    const API = 'http://192.168.100.2:3005'; // backend usuarios // backend usuarios
    const loginForm = document.getElementById('loginForm');
    const mensajeBienvenida = document.getElementById('mensajeBienvenida');
    const mensajeError = document.getElementById('mensajeError');
    const btnVolver = document.getElementById('btnVolver');

    btnVolver.addEventListener('click', () => { window.location.href = 'index.html'; });

    // Normaliza el valor de rol a admin/compras/employer
    function normalizarRole(valor) {
      const r = String(valor || '').trim().toLowerCase();
      if (['administrador', 'admin'].includes(r)) return 'admin';
      if (['comprador', 'compras'].includes(r)) return 'compras';
      if (['empleado', 'empleada', 'employee', 'employer', 'profesor', 'farmaceutico', 'farmac√©utico'].includes(r)) return 'employer';
      return r;
    }

    // Calcula la carpeta base (p.ej. "/capasfront/")
    const BASE = location.pathname.replace(/[^/]+$/, '');

    // üîê LOGIN
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      mensajeBienvenida.classList.add('d-none');
      mensajeError.classList.add('d-none');

      const datos = {
        idUsuario: e.target.idUsuario.value.trim(),
        password: e.target.password.value
      };

      try {
        const resp = await fetch(`${API}/api/usuarios/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(datos)
        });

        const isJson = resp.headers.get('content-type')?.includes('application/json');
        const data = isJson ? await resp.json() : {};

        if (resp.ok && data.usuario) {
          const user = data.usuario;
          const role = normalizarRole(user.role ?? user.tipo ?? user.rol);

          // Guarda datos
          localStorage.setItem('user', JSON.stringify(user));
          localStorage.setItem('rolUsuario', role);
          localStorage.setItem('nombreUsuario', user.nombre || user.idUsuario);
          localStorage.setItem('idUsuario', user.idUsuario);

          // Mensaje de bienvenida
          mensajeBienvenida.textContent = `¬°Bienvenido, ${user.nombre || user.idUsuario}!`;
          mensajeBienvenida.classList.remove('d-none');

          setTimeout(() => {
            // Rutas relativas desde la misma carpeta (robusto con BASE)
            const destinos = {
              admin:    `${BASE}admin.html`,
              compras:  `${BASE}compras.html`,
              employer: `${BASE}employer.html`
            };

            const destino = destinos[role];
            console.log('Rol normalizado:', role, '‚Üí', destino);

            if (destino) {
              window.location.href = destino;
            } else {
              mensajeError.textContent = `Rol no reconocido: ${role || '(vac√≠o)'}. Contacta al administrador.`;
              mensajeError.classList.remove('d-none');
            }
          }, 400);
        } else {
          mensajeError.textContent = (data && (data.error || data.mensaje)) || 'Acceso denegado';
          mensajeError.classList.remove('d-none');
        }
      } catch (error) {
        console.error(error);
        mensajeError.textContent = 'Error al conectar con el servidor.';
        mensajeError.classList.remove('d-none');
      }
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventario (Compras)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background:linear-gradient(135deg,#6dd5fa,#ffffff); }
    .card { border-radius:14px; box-shadow:0 8px 18px rgba(0,0,0,.12); }
    table th { background:#0d6efd; color:#fff; }
  </style>
<script>
(function() {
  function getPort(key, def) {
    const q = new URLSearchParams(window.location.search).get('port_' + key.toLowerCase());
    const ls = localStorage.getItem('PORT_' + key.toUpperCase());
    return q || ls || def;
  }
  const gw = getPort('gateway', 3000);
  window.API_GATEWAY_BASE = `http://192.168.100.2:${gw}`;
  window.API_GATEWAY = `${window.API_GATEWAY_BASE}/api`;

  function baseFor(service) {
    const p = getPort(service, null);
    return p ? `http://192.168.100.2:${p}/api` : window.API_GATEWAY;
  }
  window.API_USUARIOS   = baseFor('usuarios');
  window.API_INVENTARIO = baseFor('inventario');
  window.API_COMPRAS    = baseFor('compras');
  window.API_VENTAS     = baseFor('ventas');
})();
</script>
</head>
<body class="p-3">
  <div class="container bg-white p-3 rounded shadow">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4 class="m-0">Inventario (Compras)</h4>
      <div class="d-flex gap-2">
        <button id="btnRecargar" class="btn btn-sm btn-outline-primary">Recargar</button>
        <a class="btn btn-sm btn-outline-secondary" href="compras.html">Volver</a>
      </div>
    </div>

    <!-- Mensajes -->
    <div id="msg" class="alert d-none"></div>

    <!-- Formulario crear/editar -->
    <div class="card p-3 mb-3">
      <h6 class="mb-2">Registrar / Editar producto</h6>
      <form id="formInv">
        <input type="hidden" id="idMedicamento" />
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Marca</label>
            <input id="nombreMarca" class="form-control" required />
          </div>
          <div class="col-md-4">
            <label class="form-label">Genérico</label>
            <input id="nombreGenerico" class="form-control" required />
          </div>
          <div class="col-md-2">
            <label class="form-label">Concentración</label>
            <input id="concentracion" type="number" step="0.01" class="form-control" required />
          </div>
          <div class="col-md-2">
            <label class="form-label">Und</label>
            <input id="undMedida" class="form-control" required />
          </div>
          <div class="col-md-4">
            <label class="form-label">Presentación</label>
            <input id="presentacion" class="form-control" required />
          </div>
          <div class="col-md-3">
            <label class="form-label">Expiración</label>
            <input id="fechaExpiracion" type="date" class="form-control" required />
          </div>
          <div class="col-md-2">
            <label class="form-label">Stock</label>
            <input id="cantidadStock" type="number" class="form-control" min="0" required />
          </div>

          <!-- Proveedor -->
          <div class="col-md-4">
            <label class="form-label">Proveedor</label>
            <input id="nombreProveedor" class="form-control" required />
          </div>
          <div class="col-md-3">
            <label class="form-label">Correo</label>
            <input id="correo" type="email" class="form-control" required />
          </div>
          <div class="col-md-3">
            <label class="form-label">Teléfono</label>
            <input id="telefono" class="form-control" required />
          </div>

          <!-- Precios -->
          <div class="col-md-3">
            <label class="form-label">Precio compra</label>
            <input id="precioCompra" type="number" step="0.01" class="form-control" required />
          </div>
          <div class="col-md-3">
            <label class="form-label">Precio venta</label>
            <input id="precioVenta" type="number" step="0.01" class="form-control" required />
          </div>
        </div>

        <div class="mt-3 d-flex gap-2">
          <button class="btn btn-primary" id="btnGuardar">Guardar</button>
          <button class="btn btn-secondary" id="btnNuevo" type="button">Nuevo</button>
        </div>
      </form>
    </div>

    <!-- Tabla -->
    <div class="table-responsive">
      <table class="table table-striped" id="invTable">
        <thead>
          <tr>
            <th>ID</th><th>Marca</th><th>Genérico</th><th>Conc.</th><th>Und</th>
            <th>Presentación</th><th>Expira</th><th>Stock</th>
            <th>Proveedor</th><th>Compra</th><th>Venta</th><th>Correo</th><th>Teléfono</th>
            <th style="width:140px">Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // ===== Guardia: solo compras/admin =====
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    if (!user || !user.tipo) { alert('Sesión inválida'); location.href='login.html'; }
    const rol = String(user.tipo).toLowerCase();
    if (rol !== 'compras' && rol !== 'admin') { alert('Acceso no autorizado'); location.href='login.html'; }

    // ===== API =====
    const API = { inv: 'http://192.168.100.2:3003/api/inventario' };

    // ===== Refs =====
    const tbody = document.querySelector('#invTable tbody');
    const msg = document.getElementById('msg');
    const form = document.getElementById('formInv');
    const btnNuevo = document.getElementById('btnNuevo');
    const btnRecargar = document.getElementById('btnRecargar');

    // Campos
    const f = id => document.getElementById(id);
    const fields = [
      'nombreMarca','nombreGenerico','concentracion','undMedida','presentacion',
      'fechaExpiracion','cantidadStock','nombreProveedor','precioCompra','precioVenta',
      'correo','telefono'
    ];

    function showMsg(text, type='success'){
      msg.textContent = text;
      msg.className = `alert alert-${type}`;
      msg.classList.remove('d-none');
      clearTimeout(msg._t); msg._t = setTimeout(()=>msg.classList.add('d-none'), 2500);
    }
    const money = n => Number(n||0).toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});

    // Cargar tabla
    async function cargar(){
      const r = await fetch(API.inv);
      const items = await r.json();
      tbody.innerHTML = '';
      if (!Array.isArray(items) || !items.length) {
        tbody.innerHTML = `<tr><td colspan="14" class="text-center text-muted">Sin registros</td></tr>`;
        return;
      }
      items.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.idMedicamento}</td>
          <td>${p.nombreMarca}</td>
          <td>${p.nombreGenerico}</td>
          <td>${p.concentracion}</td>
          <td>${p.undMedida}</td>
          <td>${p.presentacion}</td>
          <td>${(p.fechaExpiracion||'').substring(0,10)}</td>
          <td>${p.cantidadStock}</td>
          <td>${p.nombreProveedor}</td>
          <td>${money(p.precioCompra)}</td>
          <td>${money(p.precioVenta)}</td>
          <td>${p.correo}</td>
          <td>${p.telefono}</td>
          <td class="d-flex gap-1">
            <button class="btn btn-warning btn-sm" data-ed="${p.idMedicamento}">Editar</button>
            <button class="btn btn-danger btn-sm" data-del="${p.idMedicamento}">Eliminar</button>
          </td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('[data-ed]').forEach(b=>b.addEventListener('click',()=>editar(b.dataset.ed)));
      tbody.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click',()=>eliminar(b.dataset.del)));
    }

    // Nuevo (limpia form)
    btnNuevo.addEventListener('click', ()=>{
      f('idMedicamento').value = '';
      fields.forEach(k=> f(k).value = '');
      f('fechaExpiracion').value = '';
      f('cantidadStock').value = 0;
      showMsg('Formulario limpio','info');
    });

    // Guardar (crear/actualizar)
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const id = f('idMedicamento').value;
      const payload = Object.fromEntries(fields.map(k=>[k, f(k).value]));
      payload.cantidadStock = Number(payload.cantidadStock);
      payload.concentracion = Number(payload.concentracion);
      payload.precioCompra = Number(payload.precioCompra);
      payload.precioVenta = Number(payload.precioVenta);

      const url = id ? `${API.inv}/${id}` : API.inv;
      const method = id ? 'PUT' : 'POST';
      const r = await fetch(url, { method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const data = await r.json().catch(()=> ({}));
      if (r.ok){
        showMsg(id ? 'Producto actualizado' : 'Producto creado');
        if (!id && data.insertId) f('idMedicamento').value = data.insertId;
        cargar();
      } else {
        showMsg(data.error || 'Error al guardar', 'danger');
      }
    });

    // Editar
    async function editar(id){
      const r = await fetch(`${API.inv}/${id}`);
      if (!r.ok) return showMsg('No se pudo cargar el producto','danger');
      const p = await r.json();
      f('idMedicamento').value = p.idMedicamento;
      fields.forEach(k=> f(k).value = p[k] ?? '');
      f('fechaExpiracion').value = (p.fechaExpiracion||'').substring(0,10);
      showMsg('Producto cargado en el formulario','info');
      window.scrollTo({top:0,behavior:'smooth'});
    }

    // Eliminar
    async function eliminar(id){
      if (!confirm('¿Eliminar este producto?')) return;
      const r = await fetch(`${API.inv}/${id}`, { method:'DELETE' });
      const data = await r.json().catch(()=> ({}));
      if (r.ok){ showMsg('Eliminado'); cargar(); }
      else showMsg(data.error || 'No se pudo eliminar','danger');
    }

    document.getElementById('btnRecargar').addEventListener('click', cargar);
    cargar();
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventario</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<script>
(function() {
  function getPort(key, def) {
    const q = new URLSearchParams(window.location.search).get('port_' + key.toLowerCase());
    const ls = localStorage.getItem('PORT_' + key.toUpperCase());
    return q || ls || def;
  }
  const gw = getPort('gateway', 3000);
  window.API_GATEWAY_BASE = `http://192.168.100.2:${gw}`;
  window.API_GATEWAY = `${window.API_GATEWAY_BASE}/api`;

  function baseFor(service) {
    const p = getPort(service, null);
    return p ? `http://192.168.100.2:${p}/api` : window.API_GATEWAY;
  }
  window.API_USUARIOS   = baseFor('usuarios');
  window.API_INVENTARIO = baseFor('inventario');
  window.API_COMPRAS    = baseFor('compras');
  window.API_VENTAS     = baseFor('ventas');
})();
</script>
</head>
<body class="p-3" style="background:linear-gradient(135deg,#ff5f6d,#ffc371);">
  <div class="container bg-white p-3 rounded shadow">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4 class="m-0">Inventario</h4>
      <div class="d-flex gap-2">
        <button id="btnRecargar" class="btn btn-sm btn-outline-primary">Recargar</button>
        <a class="btn btn-sm btn-outline-secondary" href="employer.html">Volver</a>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-striped" id="invTable">
        <thead>
          <tr>
            <th>ID</th><th>Marca</th><th>Genérico</th><th>Conc.</th><th>Und</th>
            <th>Presentación</th><th>Expira</th><th>Stock</th><th>Precio</th><th>Editar stock</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const API = { inv: 'http://192.168.100.2:3003/api/inventario' };
    const tbody = document.querySelector('#invTable tbody');

    const rol = localStorage.getItem('rolUsuario');
    if (rol !== 'employer' && rol !== 'admin') { window.location.href = 'login.html'; }

    async function cargar(){
      const r = await fetch(API.inv);
      const items = await r.json();
      tbody.innerHTML = '';
      if (!Array.isArray(items) || !items.length) {
        tbody.innerHTML = `<tr><td colspan="10" class="text-center text-muted">Sin registros</td></tr>`;
        return;
      }
      items.forEach(p => {
        const tr = document.createElement('tr');
        const fecha = (p.fechaExpiracion||'').substring(0,10);
        tr.innerHTML = `
          <td>${p.idMedicamento}</td>
          <td>${p.nombreMarca}</td>
          <td>${p.nombreGenerico}</td>
          <td>${p.concentracion}</td>
          <td>${p.undMedida}</td>
          <td>${p.presentacion}</td>
          <td>${fecha}</td>
          <td>${p.cantidadStock}</td>
          <td>${money(p.precioVenta)}</td>
          <td>
            <div class="input-group input-group-sm" style="max-width:160px;">
              <input type="number" class="form-control" value="${p.cantidadStock}" min="0">
              <button class="btn btn-outline-success">Guardar</button>
            </div>
          </td>`;
        tbody.appendChild(tr);

        const input = tr.querySelector('input');
        const btn = tr.querySelector('button');
        btn.addEventListener('click', async () => {
          const nueva = Number(input.value);
          if (Number.isNaN(nueva) || nueva < 0) return alert('Cantidad inválida');
          const resp = await fetch(`${API.inv}/${p.idMedicamento}/stock`, {
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ cantidad:nueva })
          });
          if (resp.ok) { alert('Stock actualizado'); cargar(); }
          else { alert('No se pudo actualizar'); }
        });
      });
    }
    function money(n){ n=Number(n||0); return n.toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0}); }
    document.getElementById('btnRecargar').addEventListener('click', cargar);

    cargar();
  </script>
</body>
</html>
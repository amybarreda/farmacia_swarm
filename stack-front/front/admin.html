<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: linear-gradient(135deg, #ff5f6d, #ffc371);
      color: #333;
      min-height: 100vh;
      padding: 1rem;
    }
    .app-container {
      background: white;
      border-radius: 10px;
      padding: 1rem 1rem 1.5rem;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    }
    .btn-bombon { background-color: #4ca1af; color: white; }
    .btn-bombon:hover { background-color: #3a8a9c; color: white; }

    aside.sticky { position: sticky; top: 1rem; }
    .menu-item.active { background: #4ca1af !important; color: #fff !important; border-color: #4ca1af !important; }
    .pointer { cursor: pointer; }

    table td, table th { vertical-align: middle; }
    section.view { display: none; }
    section.view.show { display: block; }
  </style>
  <script>
  (function() {
    function getPort(key, def) {
      const q = new URLSearchParams(window.location.search).get('port_' + key.toLowerCase());
      const ls = localStorage.getItem('PORT_' + key.toUpperCase());
      return q || ls || def;
    }
    const gw = getPort('gateway', 3000);
    window.API_GATEWAY_BASE = `http://192.168.100.2:${gw}`;
    window.API_GATEWAY = `${window.API_GATEWAY_BASE}/api`;
    function baseFor(service) {
      const p = getPort(service, null);
      return p ? `http://192.168.100.2:${p}/api` : window.API_GATEWAY;
    }
    window.API_USUARIOS   = baseFor('usuarios');
    window.API_INVENTARIO = baseFor('inventario');
    window.API_COMPRAS    = baseFor('compras');
    window.API_VENTAS     = baseFor('ventas');
  })();
  </script>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- CONTENIDO PRINCIPAL -->
      <div class="col-lg-9">
        <div class="app-container">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h2 class="m-0">Panel de Administración</h2>
            <button id="btnLogout" class="btn btn-outline-secondary">Cerrar Sesión</button>
          </div>

          <div id="mensaje" class="alert d-none" role="alert" aria-live="polite"></div>

          <!-- Sección USUARIOS -->
          <section id="usuariosSection" class="view show">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h4 class="m-0">Gestión de Usuarios</h4>
              <button id="refreshUsuarios" class="btn btn-sm btn-outline-primary">Recargar</button>
            </div>

            <div class="table-responsive">
              <table class="table table-striped" id="usuariosTable">
                <thead>
                  <tr>
                    <th>ID Usuario</th>
                    <th>Nombre</th>
                    <th>Correo</th>
                    <th>Teléfono</th>
                    <th>Rol</th>
                    <th style="width: 150px">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <hr />
            <h5 id="formTitle" class="mt-3">Crear Nuevo Usuario</h5>
            <form id="usuarioForm" class="mb-3">
              <div class="row g-3">
                <div class="col-md-4">
                  <label for="idUsuario" class="form-label">ID Usuario</label>
                  <input type="text" class="form-control" id="idUsuario" required />
                </div>
                <div class="col-md-4">
                  <label for="nombre" class="form-label">Nombre</label>
                  <input type="text" class="form-control" id="nombre" required />
                </div>
                <div class="col-md-4">
                  <label for="correo" class="form-label">Correo</label>
                  <input type="email" class="form-control" id="correo" required />
                </div>
                <div class="col-md-4">
                  <label for="telefono" class="form-label">Teléfono</label>
                  <input type="text" class="form-control" id="telefono" required />
                </div>
                <div class="col-md-4">
                  <label for="role" class="form-label">Role</label>
                  <select id="role" class="form-select" required>
                    <option value="admin">admin</option>
                    <option value="compras">compras</option>
                    <option value="employer">employer</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="password_hash" class="form-label">Contraseña</label>
                  <input type="password" class="form-control" id="password_hash" required />
                </div>
              </div>

              <input type="hidden" id="editarId" value="" />
              <div class="mt-3 d-flex gap-2">
                <button type="submit" class="btn btn-bombon" id="btnSubmit">Crear Usuario</button>
                <button type="button" class="btn btn-secondary" id="btnCancelarEdicion" style="display:none;">Cancelar</button>
              </div>
            </form>
          </section>

          <!-- Sección INVENTARIO -->
          <section id="inventarioSection" class="view">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h4 class="m-0">Inventario</h4>
              <button id="refreshInventario" class="btn btn-sm btn-outline-primary">Recargar</button>
            </div>
            <div class="table-responsive">
              <table class="table table-striped" id="inventarioTable">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Producto (Marca)</th>
                    <th>Genérico</th>
                    <th>Concentración</th>
                    <th>Unidad</th>
                    <th>Presentación</th>
                    <th>Expiración</th>
                    <th>Stock</th>
                    <th>Precio Venta</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </section>

          <!-- Sección ÓRDENES DE COMPRA -->
          <section id="ordenesSection" class="view">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h4 class="m-0">Órdenes de Compra</h4>
              <button id="refreshOrdenes" class="btn btn-sm btn-outline-primary">Recargar</button>
            </div>
            <div class="table-responsive">
              <table id="ordenesTable" class="table table-striped">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Proveedor</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Detalles</th>
                    <th>Cantidad</th>
                    <th>Total</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </section>

          <!-- Sección VENTAS -->
          <section id="ventasSection" class="view">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h4 class="m-0">Ventas</h4>
              <div class="d-flex align-items-center gap-2">
                <button id="btnTotalVentas" class="btn btn-sm btn-outline-success">Calcular total ventas</button>
                <span class="badge text-bg-success" id="totalVentasBadge" style="display:none;"></span>
                <button id="refreshVentas" class="btn btn-sm btn-outline-primary">Recargar</button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-striped" id="ventasTable">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Vendedor</th>
                    <th>ID Medicamento</th>
                    <th>Producto</th>
                    <th>Cant.</th>
                    <th>Medio Pago</th>
                    <th>Precio Unit.</th>
                    <th>Total</th>
                    <th>Fecha</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </section>
        </div>
      </div>

      <!-- LATERAL DERECHO -->
      <div class="col-lg-3">
        <aside class="sticky">
          <div class="card shadow-sm">
            <div class="card-body">
              <h6 class="card-title text-uppercase text-muted">¿Qué deseas gestionar?</h6>
              <div class="list-group">
                <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center menu-item active" data-target="usuariosSection">
                  Usuarios <span class="badge bg-secondary">Default</span>
                </button>
                <button class="list-group-item list-group-item-action menu-item" data-target="inventarioSection">Inventario</button>
                <button class="list-group-item list-group-item-action menu-item" data-target="ordenesSection">Órdenes de compra</button>
                <button class="list-group-item list-group-item-action menu-item" data-target="ventasSection">Ventas</button>
              </div>
              <small class="d-block mt-2 text-muted">Inventario, órdenes y ventas se cargan sólo cuando los abres.</small>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <script>
    // ====== ENDPOINTS ======
    const API = {
      usuarios:  'http://192.168.100.2:3005/api/usuarios',
      inventario:'http://192.168.100.2:3003/api/inventario',
      ordenes:   'http://192.168.100.2:3002/api/compras',
      ventas:    'http://192.168.100.2:3004/api/ventas'
    };

    // ====== UI refs ======
    const mensaje = document.getElementById('mensaje');

    // Usuarios
    const usuariosTableBody = document.querySelector('#usuariosTable tbody');
    const usuarioForm = document.getElementById('usuarioForm');
    const idUsuarioInput = document.getElementById('idUsuario');
    const nombreInput = document.getElementById('nombre');
    const correoInput = document.getElementById('correo');
    const telefonoInput = document.getElementById('telefono');
    const roleInput = document.getElementById('role');
    const passwordInput = document.getElementById('password_hash');
    const editarIdInput = document.getElementById('editarId');
    const btnSubmit = document.getElementById('btnSubmit');
    const btnCancelarEdicion = document.getElementById('btnCancelarEdicion');

    // Inventario / Órdenes / Ventas
    const inventarioTableBody = document.querySelector('#inventarioTable tbody');
    const ordenesTableBody = document.querySelector('#ordenesTable tbody');
    const ventasTableBody = document.querySelector('#ventasTable tbody');
    const totalVentasBadge = document.getElementById('totalVentasBadge');
    const btnTotalVentas = document.getElementById('btnTotalVentas');

    // Estado de carga
    const loaded = { usuarios: false, inventario: false, ordenes: false, ventas: false };
    let ventasCache = []; // para calcular total en client

    // ====== Helpers ======
    function mostrarMensaje(texto, role = 'success') {
      mensaje.textContent = texto;
      mensaje.className = 'alert alert-' + role;
      mensaje.classList.remove('d-none');
      clearTimeout(mensaje._timer);
      mensaje._timer = setTimeout(() => mensaje.classList.add('d-none'), 4000);
    }

    function formatMoney(value) {
      if (value === undefined || value === null || value === '') return '';
      const n = Number(value);
      return isNaN(n) ? String(value) : n.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });
    }

    async function safeJson(resp) {
      try { return await resp.json(); } catch { return null; }
    }

    // Normaliza detalles (string JSON -> array)
    function toArrayDet(det) {
      if (Array.isArray(det)) return det;
      if (typeof det === 'string') {
        try { return JSON.parse(det); } catch { return null; }
      }
      return null;
    }

    // Muestra detalles bonito aunque sean string/objeto
    function prettyDetalles(det) {
      if (Array.isArray(det)) {
        return det.map(item => {
          const idm = item.idMedicamento != null ? `#${item.idMedicamento}` : '';
          const nom = item.nombreGenerico || item.nombre || item.descripcion || '';
          const conc = item.concentracion ? ` (${item.concentracion} ${item.undMedida || ''})` : '';
          const pres = item.presentacion ? ` - ${item.presentacion}` : '';
          const cant = item.cantidad != null ? ` · cant: ${item.cantidad}` : '';
          return `${idm} ${nom}${conc}${pres}${cant}`.trim();
        }).join('<br>');
      }
      if (typeof det === 'string') {
        const t = det.trim();
        if (!t) return '';
        try {
          const parsed = JSON.parse(t);
          return `<pre class="m-0">${JSON.stringify(parsed, null, 2)}</pre>`;
        } catch {
          return det;
        }
      }
      if (det && typeof det === 'object') {
        return `<pre class="m-0">${JSON.stringify(det, null, 2)}</pre>`;
      }
      return '';
    }

    // ====== Secciones ======
    const sectionIds = ['usuariosSection', 'inventarioSection', 'ordenesSection', 'ventasSection'];
    function showSection(targetId) {
      sectionIds.forEach(id => document.getElementById(id).classList.toggle('show', id === targetId));
      document.querySelectorAll('.menu-item').forEach(btn => btn.classList.toggle('active', btn.dataset.target === targetId));
      if (targetId === 'usuariosSection'   && !loaded.usuarios)   cargarUsuarios();
      if (targetId === 'inventarioSection' && !loaded.inventario) cargarInventario();
      if (targetId === 'ordenesSection'    && !loaded.ordenes)    cargarOrdenes();
      if (targetId === 'ventasSection'     && !loaded.ventas)     cargarVentas();
    }
    document.querySelectorAll('.menu-item').forEach(btn => btn.addEventListener('click', () => showSection(btn.dataset.target)));

    // ====== USUARIOS ======
    async function cargarUsuarios() {
      try {
        const resp = await fetch(API.usuarios);
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const usuarios = await resp.json();
        usuariosTableBody.innerHTML = '';
        usuarios.forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.idUsuario}</td>
            <td>${u.nombre}</td>
            <td>${u.correo}</td>
            <td>${u.telefono}</td>
            <td>${u.role}</td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-info btn-editar">Editar</button>
                <button class="btn btn-danger btn-eliminar">Eliminar</button>
              </div>
            </td>`;
          usuariosTableBody.appendChild(tr);
          tr.querySelector('.btn-editar').addEventListener('click', () => iniciarEdicion(u));
          tr.querySelector('.btn-eliminar').addEventListener('click', () => eliminarUsuario(u.idUsuario));
        });
        loaded.usuarios = true;
      } catch (err) {
        console.error(err);
        mostrarMensaje('Error al cargar usuarios', 'danger');
      }
    }

    function iniciarEdicion(usuario) {
      idUsuarioInput.value = usuario.idUsuario;
      idUsuarioInput.disabled = true;
      nombreInput.value = usuario.nombre;
      correoInput.value = usuario.correo;
      telefonoInput.value = usuario.telefono;
      roleInput.value = usuario.role;
      passwordInput.value = '';
      editarIdInput.value = usuario.idUsuario;
      btnSubmit.textContent = 'Actualizar Usuario';
      btnCancelarEdicion.style.display = 'inline-block';
    }

    btnCancelarEdicion.addEventListener('click', () => {
      usuarioForm.reset();
      idUsuarioInput.disabled = false;
      editarIdInput.value = '';
      btnSubmit.textContent = 'Crear Usuario';
      btnCancelarEdicion.style.display = 'none';
    });

    async function eliminarUsuario(idUsuario) {
      if (!confirm(`¿Está seguro de eliminar el usuario ${idUsuario}?`)) return;
      try {
        const resp = await fetch(`${API.usuarios}/${encodeURIComponent(idUsuario)}`, { method: 'DELETE' });
        if (resp.ok) {
          mostrarMensaje('Usuario eliminado exitosamente');
          loaded.usuarios = false;
          cargarUsuarios();
        } else {
          mostrarMensaje('Error eliminando usuario', 'danger');
        }
      } catch (err) {
        console.error(err);
        mostrarMensaje('Error eliminando usuario', 'danger');
      }
    }

    usuarioForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        idUsuario: idUsuarioInput.value.trim(),
        nombre: nombreInput.value.trim(),
        correo: correoInput.value.trim(),
        telefono: telefonoInput.value.trim(),
        role: roleInput.value,
        password_hash: passwordInput.value.trim()
      };
      try {
        let resp;
        if (editarIdInput.value) {
          resp = await fetch(`${API.usuarios}/${encodeURIComponent(editarIdInput.value)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          resp = await fetch(API.usuarios, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }
        if (resp.ok) {
          mostrarMensaje(editarIdInput.value ? 'Usuario actualizado' : 'Usuario creado');
          usuarioForm.reset();
          idUsuarioInput.disabled = false;
          editarIdInput.value = '';
          btnSubmit.textContent = 'Crear Usuario';
          btnCancelarEdicion.style.display = 'none';
          loaded.usuarios = false;
          cargarUsuarios();
        } else {
          const errorData = await safeJson(resp);
          mostrarMensaje((errorData && errorData.error) || 'Error en la operación', 'danger');
        }
      } catch (err) {
        console.error(err);
        mostrarMensaje('Error en la comunicación con el servidor', 'danger');
      }
    });

    // ====== INVENTARIO ======
    async function cargarInventario() {
      try {
        const resp = await fetch(API.inventario);
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const items = await resp.json();
        inventarioTableBody.innerHTML = '';
        if (!Array.isArray(items) || items.length === 0) {
          inventarioTableBody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">Sin registros</td></tr>`;
        } else {
          items.forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${p.idMedicamento ?? ''}</td>
              <td>${p.nombreMarca ?? ''}</td>
              <td>${p.nombreGenerico ?? ''}</td>
              <td>${p.concentracion ?? ''}</td>
              <td>${p.undMedida ?? ''}</td>
              <td>${p.presentacion ?? ''}</td>
              <td>${(p.fechaExpiracion || '').substring(0,10)}</td>
              <td>${p.cantidadStock ?? ''}</td>
              <td>${formatMoney(p.precioVenta)}</td>`;
            inventarioTableBody.appendChild(tr);
          });
        }
        loaded.inventario = true;
      } catch (err) {
        console.error(err);
        mostrarMensaje('Error al cargar inventario', 'danger');
      }
    }

    // ====== ÓRDENES ======
    async function cargarOrdenes() {
      try {
        const resp = await fetch(API.ordenes);
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const ordenes = await resp.json();
        ordenesTableBody.innerHTML = '';
        if (!Array.isArray(ordenes) || ordenes.length === 0) {
          ordenesTableBody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">Sin registros</td></tr>`;
        } else {
          ordenes.forEach(o => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${o.idOrden ?? ''}</td>
              <td>${o.nombreProveedor ?? ''}</td>
              <td>${o.fechaOrden ? new Date(o.fechaOrden).toLocaleDateString('es-CO') : ''}</td>
              <td>${o.estado ?? ''}</td>
              <td>${prettyDetalles(o.detalles)}</td>
              <td>${o.cantidadCompra ?? ''}</td>
              <td>${formatMoney(o.montoTotal)}</td>
              <td>
                <div class="btn-group btn-group-sm" role="group">
                  <button class="btn btn-outline-success"  data-action="estado" data-estado="aprobada">Aprobar</button>
                  <button class="btn btn-outline-primary"  data-action="estado" data-estado="enviada">Enviar</button>
                  <button class="btn btn-outline-warning"  data-action="estado" data-estado="recibido">Recibir</button>
                  <button class="btn btn-outline-danger"   data-action="eliminar">Eliminar</button>
                </div>
              </td>`;
            ordenesTableBody.appendChild(tr);

            tr.querySelectorAll('button[data-action="estado"]').forEach(btn => {
              btn.addEventListener('click', () => actualizarEstado(o.idOrden, btn.dataset.estado));
            });
            tr.querySelector('button[data-action="eliminar"]').addEventListener('click', () => eliminarOrden(o.idOrden));
          });
        }
        loaded.ordenes = true;
      } catch (err) {
        console.error(err);
        mostrarMensaje('Error al cargar órdenes de compra', 'danger');
      }
    }

    async function actualizarEstado(idOrden, nuevoEstado) {
      try {
        // Traer la orden actual
        const resp = await fetch(`${API.ordenes}/${idOrden}`);
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const orden = await resp.json();

        // idUsuario del admin logueado (o fallback al de la orden)
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        const idUsuario = user?.idUsuario || orden.idUsuario;

        const body = { ...orden, idUsuario, estado: nuevoEstado };

        // Si es "recibido", validar y enviar solo {idMedicamento, cantidad}
        if (String(nuevoEstado).toLowerCase() === 'recibido') {
          const det = toArrayDet(orden.detalles);
          if (!Array.isArray(det) || det.length === 0) {
            mostrarMensaje('Para "Recibir" la orden, los detalles deben ser un arreglo JSON.', 'danger');
            return;
          }
          const faltantes = det.filter(x => x == null || x.idMedicamento == null || x.cantidad == null);
          if (faltantes.length) {
            mostrarMensaje('Cada ítem debe incluir idMedicamento y cantidad', 'danger');
            return;
          }
          body.detalles = det.map(x => ({ idMedicamento: Number(x.idMedicamento), cantidad: Number(x.cantidad) }));
        } else {
          body.detalles = orden.detalles; // sin cambios para otros estados
        }

        const upd = await fetch(`${API.ordenes}/${idOrden}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await safeJson(upd);
        if (!upd.ok) throw new Error((data && data.error) || ('HTTP ' + upd.status));

        mostrarMensaje('Estado actualizado');
        cargarOrdenes();
      } catch (e) {
        console.error(e);
        mostrarMensaje('No se pudo actualizar el estado: ' + e.message, 'danger');
      }
    }

    async function eliminarOrden(idOrden) {
      if (!confirm('¿Seguro que deseas eliminar esta orden?')) return;
      try {
        const resp = await fetch(`${API.ordenes}/${idOrden}`, { method: 'DELETE' });
        if (resp.ok) {
          mostrarMensaje('Orden eliminada.');
          cargarOrdenes();
        } else {
          mostrarMensaje('Error al eliminar orden.', 'danger');
        }
      } catch (e) {
        console.error(e);
        mostrarMensaje('Error al eliminar orden.', 'danger');
      }
    }

    // ====== VENTAS ======
    async function cargarVentas() {
      try {
        const resp = await fetch(API.ventas);
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const ventas = await resp.json();
        ventasCache = Array.isArray(ventas) ? ventas : [];
        ventasTableBody.innerHTML = '';

        if (ventasCache.length === 0) {
          ventasTableBody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">Sin registros</td></tr>`;
        } else {
          ventasCache.forEach(v => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${v.idVenta ?? ''}</td>
              <td>${v.idVendedor ?? ''}</td>
              <td>${v.idMedicamento ?? ''}</td>
              <td>${v.nombreMedicamento ?? ''}</td>
              <td>${v.cantidadVendida ?? ''}</td>
              <td>${v.medioPago ?? ''}</td>
              <td>${formatMoney(v.precioUnitario)}</td>
              <td>${formatMoney(v.totalVenta)}</td>
              <td>${v.fechaVenta ? new Date(v.fechaVenta).toLocaleString('es-CO') : ''}</td>`;
            ventasTableBody.appendChild(tr);
          });
        }
        totalVentasBadge.style.display = 'none';
        loaded.ventas = true;
      } catch (err) {
        console.error(err);
        mostrarMensaje('Error al cargar ventas', 'danger');
      }
    }

    function calcularTotalVentas() {
      const total = ventasCache.reduce((acc, v) => acc + Number(v.totalVenta || 0), 0);
      totalVentasBadge.textContent = 'Total: ' + formatMoney(total);
      totalVentasBadge.style.display = 'inline-block';
    }
    btnTotalVentas.addEventListener('click', calcularTotalVentas);

    // ====== Controles de recarga manual ======
    document.getElementById('refreshUsuarios').addEventListener('click', () => { loaded.usuarios = false; cargarUsuarios(); });
    document.getElementById('refreshInventario').addEventListener('click', () => { loaded.inventario = false; cargarInventario(); });
    document.getElementById('refreshOrdenes').addEventListener('click', () => { loaded.ordenes = false; cargarOrdenes(); });
    document.getElementById('refreshVentas').addEventListener('click', () => { loaded.ventas = false; cargarVentas(); totalVentasBadge.style.display='none'; });

    // ====== Seguridad mínima y logout ======
    function checkAdmin() {
      const rol = localStorage.getItem('rolUsuario');
      if (rol !== 'admin') {
        alert('Acceso no autorizado.');
        window.location.href = 'login.html';
      }
    }
    document.getElementById('btnLogout').addEventListener('click', () => {
      localStorage.clear();
      window.location.href = 'login.html';
    });

    // ====== Inicio ======
    window.addEventListener('DOMContentLoaded', () => {
      checkAdmin();
      cargarUsuarios();            // por defecto
      showSection('usuariosSection');
    });
  </script>
</body>
</html>